<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CoBean - コーヒー豆提案アプリ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
  <div class="container">
    <div class="left">
      <div class="title">
        <img src="{{ url_for('static', filename='icon.png') }}" alt="CoBean" class="title-icon" />
        <h1>CoBean</h1>
      </div>

      <form method="POST">
        {% for label, var in [
          ('酸味', 'acidity'),
          ('苦味', 'bitterness'),
          ('コク', 'body'),
          ('風味', 'flavor'),
          ('後味', 'aftertaste')
        ] %}
        <div class="slider-group">
          <label for="{{ var }}">{{ label }}: <span id="{{ var }}-val">{{ slider_values[var] }}</span></label>
          <input
            type="range" min="0" max="10" step="0.1"
            name="{{ var }}" id="{{ var }}"
            value="{{ slider_values[var] }}"
            data-default="5.0"
          />
          <div class="slider-labels"><span>0</span><span>10</span></div>
        </div>
        {% endfor %}
        <button type="submit">送信</button>
        <button type="button" id="resetBtn" class="secondary">リセット</button>
      </form>
    </div>

    <div class="right">
      <div class="card single-card">
        <div class="card-header">
          <img src="{{ url_for('static', filename='icon.png') }}" alt="豆アイコン" class="card-icon" />
          <h2 class="card-title">
            {% if best_bean %} {{ best_bean['名前'] }} {% else %} あなたへおすすめの豆 {% endif %}
          </h2>
        </div>

        <div class="card-chart">
          <canvas id="radarChart"></canvas>
        </div>

        <div class="card-body">
          <p>酸味：{{ best_bean['酸味'] if best_bean else '-' }}</p>
          <p>苦味：{{ best_bean['苦味'] if best_bean else '-' }}</p>
          <p>コク：{{ best_bean['コク'] if best_bean else '-' }}</p>
          <p>風味：{{ best_bean['風味'] if best_bean else '-' }}</p>
          <p>後味：{{ best_bean['後味'] if best_bean else '-' }}</p>
        </div>
      </div>
    </div>
  </div>

  {% if results %}
<div class="table-container">
  <details open>
    <summary>おすすめの豆</summary>

    <table>
      <thead>
        <tr>
          {% for key in results[0].keys() %}
            <th>{{ key }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in results %}
          {# 味覚カラムだけ取り出して最大/最小を求める #}
          {% set taste_keys = ['酸味','苦味','コク','風味','後味'] %}
          {% set taste_vals = [row['酸味'], row['苦味'], row['コク'], row['風味'], row['後味']] %}
          {% set max_val = taste_vals|max %}
          {% set min_val = taste_vals|min %}

          <tr>
            {% for key in results[0].keys() %}
              {% set val = row[key] %}
              <td class="
                {% if max_val != min_val and key in taste_keys and val == max_val %}taste-max{% elif max_val != min_val and key in taste_keys and val == min_val %}taste-min{% endif %}
              ">{{ val }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>

  </details>
</div>
{% endif %}


  <!-- 初期スライダー値を安全に埋め込む（現状表示値） -->
  <script id="slider-values" type="application/json">{{ slider_values | tojson }}</script>
  <script>
    const sliderValues = JSON.parse(document.getElementById('slider-values').textContent);
  </script>

  {% if chart_data %}
  <!-- チャート用データ -->
  <script id="chart-data" type="application/json">{{ chart_data | tojson }}</script>
  <script>
    const chartData = JSON.parse(document.getElementById('chart-data').textContent);

    // ユーザー設定（スライダー）を JSON から配列化
    const userPrefs = [
      sliderValues.acidity,
      sliderValues.bitterness,
      sliderValues.body,
      sliderValues.flavor,
      sliderValues.aftertaste
    ];

    const ctx = document.getElementById('radarChart').getContext('2d');
    let step = 0;
    const maxStep = 15;
    let radarChart;

    function createChart(data) {
      radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: chartData.categories,
          datasets: [
            {
              label: 'あなたへのおすすめ',
              data: data,
              fill: true,
              backgroundColor: 'rgba(173, 216, 230, 0.5)',
              borderColor: 'rgba(135, 206, 235, 1)',
              borderWidth: 2
            },
            {
              label: 'あなたの設定',
              data: userPrefs,
              fill: false,
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(255, 99, 132, 1)',
              pointBorderColor: '#fff',
              pointRadius: 4,
              pointHoverRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              min: 0,
              max: 10,
              ticks: { stepSize: 2, backdropColor: 'transparent' },
              pointLabels: { backdropColor: 'transparent' }
            }
          }
        }
      });
    }

    function updateChart(data) {
      radarChart.data.datasets[0].data = data;
      radarChart.update();
    }

    function animateRadar() {
      step++;
      const interpolated = chartData.values.map(v => v * (step / maxStep));
      if (step === 1) createChart(interpolated);
      else updateChart(interpolated);
      if (step < maxStep) setTimeout(animateRadar, 50);
    }

    animateRadar();
  </script>
  {% endif %}

  <script>
    // ラベル同期
    function syncLabel(id, value) {
      const span = document.getElementById(`${id}-val`);
      if (span) span.textContent = value;
    }

    // 初期同期 & 入力同期
    const sliderKeys = ['acidity','bitterness','body','flavor','aftertaste'];
    document.querySelectorAll('input[type=range]').forEach(slider => {
      syncLabel(slider.id, slider.value);
      slider.addEventListener('input', e => {
        syncLabel(e.target.id, e.target.value);

        // 入力中にチャートの「あなたの設定」も更新（存在すれば）
        if (typeof radarChart !== 'undefined' && radarChart?.data?.datasets?.[1]) {
          const latest = sliderKeys.map(k => parseFloat(document.getElementById(k).value));
          radarChart.data.datasets[1].data = latest;
          radarChart.update();
        }
      });
    });

    // リセットボタン：data-default → defaultValue → 5.0 の順で戻す
    (function setupReset() {
      const btn = document.getElementById('resetBtn');
      if (!btn) return;

      btn.addEventListener('click', () => {
        document.querySelectorAll('input[type="range"]').forEach(input => {
          const v = (input.dataset && input.dataset.default !== undefined)
            ? input.dataset.default
            : (input.defaultValue !== undefined ? input.defaultValue : '5.0');
          input.value = v;
          syncLabel(input.id, v);
        });

        // チャートの「あなたの設定」を現在のスライダー値で更新（存在すれば）
        if (typeof radarChart !== 'undefined' && radarChart?.data?.datasets?.[1]) {
          const latest = sliderKeys.map(k => parseFloat(document.getElementById(k).value));
          radarChart.data.datasets[1].data = latest;
          radarChart.update();
        }

        // おすすめ側のアニメをやり直したい場合
        // if (typeof step !== 'undefined' && typeof animateRadar === 'function') {
        //   step = 0;
        //   animateRadar();
        // }
      });
    })();
  </script>
</body>
</html>
